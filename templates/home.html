<!DOCTYPE html>
<html lang="ja">
<head>
    <title>HOME</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="/css/empty.css">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/ionicons.min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        .clock {
            font-size: 30px;
            text-align: center;
            color: #5c5c5c;
        }

        .hs {
            font-size: 50px;
            text-align: center;
        }

        .headers {
            display: block;
        }

        .timer {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .timer input {
            font-size: 20px;
            text-align: center;
            width: 50px;
        }

        .timer button {
            font-size: 20px;
            background-color: red;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        .timer button:hover {
            background-color: darkred;
        }

        .message {
            font-size: 20px;
            color: red;
            margin-top: 20px;
        }

        .status-message {
            font-size: 20px;
            margin-top: 10px;
            text-align: center;
            color: blue;
        }
    </style>
</head>
<body class="no-theme">
    <div class="headers">
        <p href="/" class="hs">Yuki Youtube</p>
        <div class="clock"></div>
        <div class="status-message" id="statusMessage"></div>
    </div>
    <hr />
    <div class="pure-g h-box" id="search-widget">
        <div class="pure-u-1" id="logo">
            <a href="/bbs">掲示板</a>&nbsp;&nbsp;
            <a href="/ex3about">about</a>
            <a href="/forms">リクエスト</a>&nbsp;&nbsp;
            <a href="https://sites.google.com/view/b9514" target="_blank">info</a>&nbsp;&nbsp;
            <a href="/requestform">新機能の要望やバグ報告</a>
        </div>
        <div class="pure-u-1-4"></div>
        <div class="pure-u-1 pure-u-md-12-24 searchbar">
            <form class="pure-form" id="searchForm" action="/search" method="get" target="_blank">
                <fieldset>
                    <input type="search" id="searchbox" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false" autofocus="" name="q" placeholder="検索" title="検索" value="">
                </fieldset>
            </form>
        </div>
        <div class="pure-u-1-4"></div>
    </div>

    <div class="timer" style="color: red;">
        <h2>タイマー</h2>
        <label style="color: red;">時間: <input type="number" id="timerHours" min="0" value="0"></label>
        <label style="color: red;">分: <input type="number" id="timerMinutes" min="0" value="0"></label>
        <label style="color: red;">秒: <input type="number" id="timerSeconds" min="0" value="0"></label>
        <button onclick="startTimer()">スタート</button>
        <button id="pauseButton" onclick="pauseOrResumeTimer()">一時停止</button>
        <button onclick="resetTimer()">停止</button>
        <div>
            <input type="checkbox" id="soundToggle">
            <label for="soundToggle" style="color: red;">音を鳴らす</label>
        </div>
        <div id="timerDisplay"></div>
        <div class="message" id="message"></div>
    </div>
    <script>
        let timesignalActivated = false;
        let timerInterval;
        let remainingSeconds = 0;
        let isPaused = false;

        $('#searchbox').autocomplete({
            source: function (request, response) {
                var url = "/suggest?keyword=" + request.term;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", url);
                xhr.onload = function() {
                    response(JSON.parse(xhr.responseText));
                }
                xhr.send();
            },
            delay: 300
        });

        $('#searchbox').on('keydown', function(event) {
            if (event.key === 'Enter') {
                const command = this.value.trim().toLowerCase();
                if (command === '/timesignal on') {
                    timesignalActivated = true;
                    updateStatusMessage("時報機能が有効になりました！");
                    event.preventDefault();
                } else if (command === '/timesignal off') {
                    timesignalActivated = false;
                    updateStatusMessage("時報機能が無効になりました！");
                    event.preventDefault();
                } else if (command === '/timer') {
                    $('.timer').show();
                    event.preventDefault();
                }
                this.value = '';  // エンターを押したら検索バー内の文字を消す
            }
        });

        function displayTime() {
        const padZero = value => value.toString().padStart(2, '0');
        const now = new Date();
        const month = padZero(now.getMonth()+1);
        const day = padZero(now.getDate());
        let hours = now.getHours();
        const minutes = padZero(now.getMinutes());
        const seconds = padZero(now.getSeconds());

        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'

        const h = padZero(hours);
        const currentTime = `${month}\/${day} ${h}:${minutes}:${seconds} ${ampm}`;
        document.querySelector('.clock').textContent = currentTime;

            if (timesignalActivated) {
                checkTimeForTimesignal(hours, minutes);
            }
        }

        function checkTimeForTimesignal(hours, minutes) {
            const alertHours = [0, 6, 12, 15, 18, 22];
            const current24Hours = new Date().getUTCHours() + 9; // 日本時間に変換（UTC+9）
            if (current24Hours >= 24) current24Hours -= 24; // 24時を超えた場合の補正
            if (alertHours.includes(current24Hours) && minutes === '00') {
                document.getElementById('message').textContent = `時報: ${current24Hours}時です。`;
                if (document.getElementById('soundToggle').checked) {
                    playBeep();
                }
            }
        }

        function startTimer() {
            if (isPaused) {
                resumeTimer();
                return;
            }
            const hours = parseInt(document.getElementById('timerHours').value);
            const minutes = parseInt(document.getElementById('timerMinutes').value);
            const seconds = parseInt(document.getElementById('timerSeconds').value);
            remainingSeconds = (hours * 3600) + (minutes * 60) + seconds;

            function updateTimerDisplay() {
                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;
                document.getElementById('timerDisplay').textContent = `残り: ${hours}時間 ${minutes}分 ${seconds}秒`;
                if (remainingSeconds <= 0) {
                    document.getElementById('message').textContent = 'タイマーが終了しました！';
                    if (document.getElementById('soundToggle').checked) {
                        playBeep();
                    }
                    clearInterval(timerInterval);
                }
                remainingSeconds--;
            }

            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function pauseOrResumeTimer() {
            if (isPaused) {
                resumeTimer();
            } else {
                pauseTimer();
            }
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            isPaused = true;
            document.getElementById('pauseButton').textContent = "再開";
        }

        function resumeTimer() {
            isPaused = false;
            document.getElementById('pauseButton').textContent = "一時停止";
            startTimer();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            remainingSeconds = 0;
            document.getElementById('timerDisplay').textContent = '';
            document.getElementById('timerHours').value = 0;
            document.getElementById('timerMinutes').value = 0;
            document.getElementById('timerSeconds').value = 0;
            document.getElementById('message').textContent = '';
            isPaused = false;
            document.getElementById('pauseButton').textContent = "一時停止";
        }

        function playBeep() {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(1000, context.currentTime); // 1000 Hz
            oscillator.connect(context.destination);
            oscillator.start();

            let beepCount = 0;
            const beepInterval = setInterval(() => {
                beepCount++;
                if (beepCount >= 5) { // ビープ音を5回鳴らす
                    clearInterval(beepInterval);
                    oscillator.stop();
                } else {
                    oscillator.stop(context.currentTime + 0.5); // 500ミリ秒間鳴らす
                    oscillator.start(context.currentTime + 1); // 1秒後に再開
                }
            }, 1000);
        }

        function updateStatusMessage(message) {
            const statusMessageElement = document.getElementById('statusMessage');
            statusMessageElement.textContent = message;
            statusMessageElement.style.backgroundColor = 'yellow';
            setTimeout(() => {
                statusMessageElement.textContent = '';
                statusMessageElement.style.backgroundColor = 'transparent';
            }, 3000);
        }

        displayTime();
        setInterval(displayTime, 1000);
    </script>
</body>
</html>
