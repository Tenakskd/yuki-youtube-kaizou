<!DOCTYPE html>
<html lang="ja">
<head>
    <title>HOME</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="/css/empty.css">
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/ionicons.min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        .clock {
            font-size: 30px;
            text-align: center;
            color: #5c5c5c;
        }

        .hs {
            font-size: 50px;
            text-align: center;
        }

        .headers {
            display: block;
        }

        .timer {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .timer input {
            font-size: 20px;
            text-align: center;
            width: 50px;
        }

        .timer button {
            font-size: 20px;
        }
    </style>
</head>
<body class="no-theme">
    <div class="headers">
        <p href="/" class="hs">Yuki Youtube</p>
        <div class="clock"></div>
    </div>
    <hr />
    <div class="pure-g h-box" id="search-widget">
        <div class="pure-u-1" id="logo">
            <a href="/bbs">掲示板</a>&nbsp;&nbsp;
            <a href="/ex3about">about</a>
            <a href="/forms">リクエスト</a>&nbsp;&nbsp;
            <a href="https://sites.google.com/view/b9514" target="_blank">info</a>&nbsp;&nbsp;
            <a href="/requestform">新機能の要望やバグ報告</a>
        </div>
        <div class="pure-u-1-4"></div>
        <div class="pure-u-1 pure-u-md-12-24 searchbar">
            <form class="pure-form" id="searchForm" action="/search" method="get">
                <fieldset>
                    <input type="search" id="searchbox" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false" autofocus="" name="q" placeholder="検索" title="検索" value="">
                </fieldset>
            </form>
        </div>
        <div class="pure-u-1-4"></div>
    </div>

    <div class="timer">
        <h2>タイマー</h2>
        <label>分: <input type="number" id="timerMinutes" min="0" value="0"></label>
        <label>秒: <input type="number" id="timerSeconds" min="0" value="0"></label>
        <button onclick="startTimer()">スタート</button>
        <div id="timerDisplay"></div>
    </div>

    <script>
        let timesignalActivated = false;
        let timerInterval;
        let endTime;

        $('#searchbox').autocomplete({
            source: function (request, response) {
                var url = "/suggest?keyword=" + request.term;
                var xhr = new XMLHttpRequest();
                xhr.open("GET", url);
                xhr.onload = function() {
                    response(JSON.parse(xhr.responseText));
                }
                xhr.send();
            },
            delay: 300
        });

        $('#searchbox').on('keydown', function(event) {
            if (event.key === 'Enter') {
                const command = this.value.trim().toLowerCase();
                if (command === '/timesignal on') {
                    timesignalActivated = true;
                    alert("時報機能が有効になりました！");
                    event.preventDefault();  // フォームのデフォルトの送信を防ぐ
                } else if (command === '/timesignal off') {
                    timesignalActivated = false;
                    alert("時報機能が無効になりました！");
                    event.preventDefault();  // フォームのデフォルトの送信を防ぐ
                } else if (command === '/timer') {
                    $('.timer').show();
                    event.preventDefault();  // フォームのデフォルトの送信を防ぐ
                }
            }
        });

        function displayTime() {
            const padZero = value => value.toString().padStart(2, '0');
            const now = new Date();
            let hours = now.getHours();
            const minutes = padZero(now.getMinutes());
            const seconds = padZero(now.getSeconds());

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'

            const h = padZero(hours);
            const currentTime = `${h}:${minutes}:${seconds} ${ampm}`;
            document.querySelector('.clock').textContent = currentTime;

            if (timesignalActivated) {
                checkTimeForTimesignal(hours, minutes);
            }
        }

        function checkTimeForTimesignal(hours, minutes) {
            const alertHours = [0, 6, 12, 15, 22];
            const current24Hours = new Date().getHours(); // 24-hour format
            if (alertHours.includes(current24Hours) && minutes === '00') {
                alert(`時報: ${current24Hours}時です。`);
            }
        }

        function startTimer() {
            const minutes = parseInt(document.getElementById('timerMinutes').value);
            const seconds = parseInt(document.getElementById('timerSeconds').value);
            const totalSeconds = (minutes * 60) + seconds;
            endTime = Date.now() + totalSeconds * 1000;
            localStorage.setItem('timerEndTime', endTime);

            if (timerInterval) {
                clearInterval(timerInterval);
            }

            function updateTimerDisplay() {
                const now = Date.now();
                const remainingSeconds = Math.max(0, Math.floor((endTime - now) / 1000));
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                document.getElementById('timerDisplay').textContent = `残り: ${minutes}分 ${seconds}秒`;
                if (remainingSeconds <= 0) {
                    alert('タイマーが終了しました！');
                    clearInterval(timerInterval);
                    localStorage.removeItem('timerEndTime');
                }
            }

            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function restoreTimer() {
            const savedEndTime = localStorage.getItem('timerEndTime');
            if (savedEndTime) {
                endTime = parseInt(savedEndTime, 10);
                if (Date.now() < endTime) {
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                    $('.timer').show();
                    timerInterval = setInterval(function() {
                        updateTimerDisplay();
                    }, 1000);
                } else {
                    localStorage.removeItem('timerEndTime');
                }
            }
        }

        displayTime();
        setInterval(displayTime, 1000);
        restoreTimer();
    </script>
</body>
</html>
